---
title: "Exploratory analysing on World Happiness Report"
author:
- familyname: Li
  othernames: Weihao
  address: Monash University
  email: wlii0039@student.monash.edu
  correspondingauthor: true
  qualifications: 28723740
- familyname: Curie
  othernames: Pierre
  address: University of Paris
  qualifications: Nobel Prize, PhD
department: Department of\newline Econometrics &\newline Business Statistics
organization: ETC5513 Assignment 4
bibliography: references.bib
biblio-style: apa
linestretch: 1.5
output:
  MonashEBSTemplates::report:
    fig_caption: yes
    fig_height: 5
    fig_width: 8
    includes:
      in_header: preamble.tex
    keep_tex: yes
    number_sections: yes
    citation_package: biblatex
    toc: false
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, cache=FALSE, messages=FALSE, warning=FALSE)
# Make sure you have the latest versions of rmarkdown and bookdown installed
library(tidyverse)

```


# Q4. What is the relationship between predictors and happiness score?

```{r message=FALSE}
h15 = read_csv("Data/2015.csv")
h16 = read_csv("Data/2016.csv")
h17 = read_csv("Data/2017.csv")
h18 = read_csv("Data/2018.csv")
h18$`Perceptions of corruption` = as.numeric(h18$`Perceptions of corruption`)
h19 = read_csv("Data/2019.csv")
```

<!--

```{r}
mod15 = lm(as.formula(paste('`', 
                            colnames(h15)[4], "`~`",
                            paste(colnames(h15)[c(6, 7, 8, 9, 10, 11, 12)], collapse = "`+`"),
                            '`',
        sep = ""
    )), data = h15)
```

```{r mod2015}
c_table = summary(mod15)

rownames(c_table$coefficients) = c_table$coefficients %>%
  rownames() %>%
  stringr::str_remove_all('`')

c_table$coefficients %>%
  knitr::kable('latex', 
               digits = 4, 
               booktabs = TRUE,
               caption = "Linear regression model for happiness scores in 2015. The $R^2$ of this model is 1. In the dataset, these factors are standardized.") %>%
  kableExtra::kable_styling(latex_options = "striped")
```


To explore the relationship between hapiness score and factors including economy, family, health, freedom, trust and generosity, a linear regression model for the 2015 data was developed. Results of this model is shown in Table \ref{tab:mod2015}. From the result, we can conclude the estimated closed form of hapiness score:

\begin{align*}
\text{Hapiness score} = & \text{ GDP per Capita } + \text{ Family } + \text{ Life expectancy }+ \text{ Freedom } +   \\ 
&  \text{ Government Corruption } + \text{ Generosity } + \text{Dystopia Residual }
\end{align*}

There is strong evidence that the happiness score is and only is a simple average of these factors. Therefore, the relationship between happiness score and these factors is no longer interesting to us.

This situation also happens in 2016 and 2017 data. Besides, for 2018 and 2019 data, the organization provides another set of variables which are also highly correlated with the happiness score, but we have no method to understand what those values represent since they have been transformed in an unknown manner.

Instead of using the factors in the given dataset, we join other datasets to analysis the happiness score, including GDP, CPI, population and area by country. GDP, CPI and population data is downloaded from The World Bank. And area of each country is computed using the simple feature polygons provided in package `rnaturalearth`.

-->

```{r message=FALSE, warning=FALSE}
library(rnaturalearth)
library(sf)
world_map = ne_countries(returnclass = 'sf')
gdp = read_csv("Data/API_NY.GDP.MKTP.CD_DS2_en_csv_v2_1120928.csv", skip = 4)
cpi = read_csv("Data/API_FP.CPI.TOTL.ZG_DS2_en_csv_v2_1120899.csv", skip = 4)
population = read_csv("Data/API_SP.POP.TOTL_DS2_en_csv_v2_1120881.csv", skip = 4)
```

```{r}
temp = h15 %>%
  select(Country, `Happiness Score`) %>%
  mutate(year = 2015)

h16 %>%
  select(Country, `Happiness Score`) %>%
  mutate(year = 2016) %>%
  rbind(temp) -> temp

h17 %>%
  select(Country, `Happiness Score` = Happiness.Score) %>%
  mutate(year = 2017) %>%
  rbind(temp) -> temp

h18 %>%
  select(Country = `Country or region`, `Happiness Score` = Score) %>%
  mutate(year = 2018) %>%
  rbind(temp) -> temp

h19 %>%
  select(Country = `Country or region`, `Happiness Score` = Score) %>%
  mutate(year = 2019) %>%
  rbind(temp) -> temp
```

```{r}
hs = temp
```

```{r message=FALSE}
population %>%
  select(Country = `Country Name`, `2015`:`2019`) %>%
  gather(key = 'year', value = 'population', `2015`:`2019`) %>%
  mutate(year = as.numeric(year)) %>%
  right_join(hs) -> hs

gdp %>%
  select(Country = `Country Name`, `2015`:`2019`) %>%
  gather(key = 'year', value = 'gdp', `2015`:`2019`) %>%
  mutate(year = as.numeric(year)) %>%
  right_join(hs) -> hs

cpi %>%
  select(Country = `Country Name`, `2015`:`2019`) %>%
  gather(key = 'year', value = 'cpi', `2015`:`2019`) %>%
  mutate(year = as.numeric(year)) %>%
  right_join(hs) -> hs
```

```{r warning=FALSE, message=FALSE}
world_map$area = st_area(world_map) %>% as.numeric()

as_tibble(world_map) %>%
  select(area, name) %>%
  right_join(hs, by = c('name' = 'Country')) -> hs

```

```{r }
nona_hs = na.omit(hs)

nona_hs = nona_hs %>%
  mutate(log_score = log(`Happiness Score`), log_cpi = log(cpi), log_gdp = log(gdp), log_area = log(area), log_population = log(population)) %>%
  select(log_score:log_population)

lm(log_score~log_cpi+log_gdp+log_population+log_area,data=nona_hs) %>%
  summary() -> lm_sum

```


```{r lmcoeff}

rownames(lm_sum$coefficients) = lm_sum$coefficients %>%
  rownames() %>%
  stringr::str_remove_all('`')

lm_sum$coefficients %>%
  knitr::kable('latex', 
               digits = 4, 
               booktabs = TRUE,
               caption = "Linear regression model for happiness scores. The $R^2$ of this model is 0.7288.") %>%
  kableExtra::kable_styling(latex_options = "striped")
```

We use variables which mentioned in Q3 as predictors, the regression result is shown in Table \ref{tab:lmcoeff}. According to the result, we can write down the formula for this model:

\begin{align*}
\text{log(Happiness Score)} = & \ 0.3208 + 0.0025\text{ log(CPI)} + 0.1279 \text{ log(GDP)} \\
&- 0.1223 \text{ log(Population)} + 0.0057 \text{ log(Area)}
\end{align*}

Notice that only the intercpet, log of GDP and the log of population are significant with $\alpha = 5$%. Since we take log on both response variable and regressors, we can interpret them as the elasticity of happiness score of GDP and the elasticity of happiness score of population. This can be proved by:

\begin{align}
\frac{\partial \text{log(Happiness Score)}}{\partial \text{log(GDP)}} &= 0.1279\\
\intertext{From (1) we can say, when other variables remain constant }\nonumber \\
\Delta \text{ log(Happiness Score)} &= 0.1279 \Delta \text{ log(GDP)}\\
\intertext{By using the linear approximation of log function, we can know}\nonumber\\
log(x_0 + \Delta x) - log(x_0) &\approx log(x_0) + log'(x_0)\Delta x - log(x_0)\\
&=  \frac{\Delta x}{x_0} = \text{percentage change in x}\nonumber\\
\intertext{Therefore}\nonumber\\
\frac{\Delta \text{ log(Happiness Score)}}{\Delta \text{ log(GDP)}} &\approx \frac{\Delta \text{ Happiness Score}}{\Delta \text{ GDP} }\frac{\text{GDP}}{\text{Happiness Score}}\\
&=\frac{\% \Delta \text{ Happiness Score}}{\% \Delta \text{ GDP}} \nonumber\\
&= 0.1279\nonumber
\end{align}

Now we can interpret the result from Table \ref{tab:lmcoeff}. We will only report variables that are statistically significant. Roughly, a 1% increase in GDP leads to a 0.1279% rise in the happiness score, and a 1% increase in population leads to a 0.1223% fall in the happiness score.


Apparently, the happiness score can be affected by others factors that correlated with regressors and doesn't include in our model, such as education index and social welfare system. It means endogeneity issue occurs in our model, which leads our estimator to be bias and inconsistent. We can either include more variables that we think will be useful for hapiness score prediction, or find instrumental variable and fit a Two-Stage least squares regression.



