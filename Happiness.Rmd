---
title: "Exploratory analysing on World Happiness Report"
author:
- familyname: Li
  othernames: Weihao
  address: Monash University
  email: wlii0039@student.monash.edu
  correspondingauthor: true
  qualifications: 28723740
- familyname: Curie
  othernames: Pierre
  address: University of Paris
  qualifications: Nobel Prize, PhD
department: Department of\newline Econometrics &\newline Business Statistics
organization: ETC5513 Assignment 4
bibliography: references.bib
biblio-style: apa
linestretch: 1.5
output:
  MonashEBSTemplates::report:
    fig_caption: yes
    fig_height: 5
    fig_width: 8
    includes:
      in_header: preamble.tex
    keep_tex: yes
    number_sections: yes
    citation_package: biblatex
    toc: false
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, cache=TRUE, messages=FALSE, warning=FALSE)
```

```{r library, include = FALSE, warning = FALSE}
library(ggplot2)
library(here)
library(janitor)
library(lubridate)
library(maps)
library(plotly)
library(tidyverse)
require(wbstats)
```

```{r read-in, cache = TRUE, include = FALSE}
happ_2015 <- read.csv(here::here("Data/2015.csv")) # To extract region info
happ_2019 <- read.csv(here::here("Data/2019.csv"))
```

# Happiness and Attribute Scores across the Globe

There is no formal definition of happiness, it is associated with an individual's state of mind, and we usually know it when we feel it. The happiness ranking and scores use data from the Gallup World Poll. Essentially, survey participants are asked, "from a score of 0-10, how happy are you"? [@sachs2018world]

In this section, six key criteria, which encompassess socioeconomic factors of countries are aggregated and quantified to explain the variation of happiness across countries. These criteria include GDP per capita, social support, healthy life expectancy, freedom, generosity, and absence of corruption. This section critically analyses these six variables to determine if happiness does change, according to the quality of the society people live across the world.


\clearpage

## Data, Design and Methodology

```{r happ-2019-wrangle}
happ_2019 <- happ_2019 %>%
  mutate(year = year(ymd("2019-12-31"))) %>% 
  rename(Country = Country.or.region)
```

```{r ctry-region-chk}
# Extract Countries and Regions from 2015 df
ctry_region <- happ_2015 %>% 
  select(Country, Region)

# Find countries that do not have a region
# setdiff(happ_2019$Country, ctry_region$Country) 

ctry_region$Country <-
  recode(
    ctry_region$Country,
    "Trinidad and Tobago" = "Trinidad & Tobago",
    "North Cyprus" = "Northern Cyprus",
    "Macedonia" = "North Macedonia",
    "Somaliland region" = "Somalia",
    "Sudan" = "South Sudan")
```

```{r add-ctry-region}
# Insert regions to NA regions
ctry_region <- ctry_region %>% 
  add_row(Country = "Namibia", Region = "Sub-Saharan Africa") %>%
  add_row(Country = "Gambia", Region = "Sub-Saharan Africa") %>%
  add_row(Country = "South Sudan", Region = "Sub-Saharan Africa") %>%
  mutate(Region = as.factor(Region)) 
```

```{r join-happiness-region}
# Include regions in df
# Clean names
happ_2019 <- full_join(happ_2019, ctry_region, by = "Country") %>%
  clean_names()
```

First, the happiness data from 2015 was utilised to retrieve the regions for each  country, these regions are added to the 2018 and 2019 datasets. Countries with omitted regions are then manually inserted. Next, 3 countries with missing attribute scores are removed. 

To construct the happiness score on a map, the world map data is taken from the maps package [@maps] to create a base map and retrieve the geographic coordinates of all countries in the world. Subsequently, the happiness data is further wrangled to resolve conflicting country names between the happiness and the map data; Both datasets are then joined to build the world map with the happiness score of each country.

The attribute scores of the six criteria are evaluated across the various countries and regions. The estimates of population data are employed [@wbstats] to determine if population size affects happiness scores. Similar to the world map, conflicting country names are modified so countries in both datasets match. Consequently, the attribute scores of all countries in the happiness data set are laid out on a scatter plot.

\clearpage 

## Limitations

On top of the survey response bias, it should be noted that some limitations of this analysis include non-sampling errors such as defects in the selection of survey participants and population coverage limitations. Further, with a holistic approach in determining happiness scores of each country, minute details such as  in each city or state within countries cannot be computed. Lastly, the happiness data is aggregated, thus evaluations such as comparisons between different genders or age groups may not be established.

\clearpage

## Analysis 1: 2019 Happiness Scores on the World Map

```{r world-map-data}
require(maps)
map_world <- map_data("world")
```

```{r conflict-names, include = FALSE}
# Find conflicting country names
setdiff(happ_2019$country, map_world$region)
```

```{r cleaning-ctry-names}
# Create new df for map
happ_map <- happ_2019

# setdiff(happ_2019$country, map_world$region)

# Solve conflicting names
happ_map$country <-
  recode(
    happ_map$country,
    "United Kingdom" = "UK",
    "United States" = "USA",
    "Trinidad & Tobago" = "Trinidad",
    "Northern Cyprus" = "Cyprus",
    "Hong Kong" = "China",
    "North Macedonia" = "Macedonia",
    "Palestinian Territories" = "Palestine",
    "Congo (Brazzaville)" = "Republic of Congo",
    "Congo (Kinshasa)" = "Democratic Republic of the Congo")
```

```{r happiness-map-combine}
# Join map and happiness data
map_combined <- 
  left_join(map_world, happ_map, by = c('region' = 'country')) %>%
  rename(country = "region")
```

```{r world-happiness-map, fig.align = "center", out.height="45%", fig.cap = "Happiness Scores of Countries around the World"}
happ_map_plot <- ggplot(data = map_combined) +
  geom_polygon(aes(
    x = long,
    y = lat,
    group = group,
    fill = score,
    label = country 
  ), colour = "black") +
  coord_equal() +
  scale_fill_distiller(palette = "PRGn", 
                       na.value = "light grey",
                       limits = c(2, 8)) +
  theme(
  axis.text = element_blank(),
  axis.line = element_blank(),
  axis.ticks = element_blank(),
  axis.title = element_blank(),
  panel.border = element_rect(colour = "black", fill=NA, size = 1.5),
  panel.grid = element_blank(),
  panel.background = element_rect(fill = "light blue"),
  plot.title = element_text(hjust = 0.5, size = 16, face = "bold.italic" )) +
  ggtitle("Happiness Scores around the World") +
  theme(legend.position= "bottom")

happ_map_plot

# Interactive Map
# ggplotly(happ_map_plot, tooltip = c("label", "fill"))

```

Figure \@ref(fig:world-happiness-map) depicts the happiness scores of each country on a world map. The x-axis and y-axis represent the longitude and latitude respectively. It is observed that happiness scores within continents or regions are analogous. For instance, happiness scores in Africa are relatively low compared to the rest of the world. It can be implied that these African countries may have poor happiness scores because of low economical levels or even associated with high political instability and reoccurring periodic outbreaks of armed conflict [@sachs2018world].

Comparatively, continents such as Europe, North America, and Australia have consistently high happiness scores in most countries. Moreover, the top 10 happiest countries are evidently dominated by Scandinavian countries such as Finland and Denmark. These figures can also be viewed on (**Refer to Roger top 20 tables**).

\clearpage

## Analysis 2: Compare attribute scores across countries

```{r happ-2019-longer}
# Place all attribute scores on one variable for plotting
happ_attr2019 <- happ_2019 %>%
  filter(year == 2019) %>%
  pivot_longer(cols = gdp_per_capita:perceptions_of_corruption, 
               names_to = "attr",
               values_to = "attr_score") 
```

```{r extract-pop-data}
require(wbstats)
# Retrieve population estimates of countries in the world
pop_ests2018 <- wb(indicator = "SP.POP.TOTL", startdate = 2018, enddate = 2019)

pop_ests2018 <- pop_ests2018 %>%
  select(country, value) %>%
  rename(pop_total = value)
```

```{r wrangling-for-pop-data}
# Make country names consistent with population data 
# setdiff(happiness_attr2019$country,pop_ests2018$country)
happ_attr2019$country <-
  recode(
    happ_attr2019$country,
    "Taiwan" = "China",
    "Slovakia" = "Slovak Republic",
    "Trinidad & Tobago" = "Trinidad and Tobago",
    "South Korea" = "Korea, Rep.",
    "Northern Cyprus" = "Cyprus",
    "Russia" = "Russian Federation",
    "Hong Kong" = "Hong Kong SAR, China",
    "Kyrgyzstan" = "Kyrgyz Republic",
    "Macedonia" = "North Macedonia", 
    "Ivory Coast" = "Cote d'Ivoire",
    "Congo (Brazzaville)" = "Congo, Rep.",
    "Laos" = "Lao PDR",
    "Venezuela" = "Venezuela, RB",
    "Palestinian Territories" = "West Bank and Gaza",
    "Iran" = "Iran, Islamic Rep.",
    "Congo (Kinshasa)" = "Congo, Dem. Rep.",
    "Swaziland" = "Swaziland",
    "Gambia" = "Gambia",
    "Egypt" = "Egypt, Arab Rep.",
    "Syria" = "Syrian Arab Republic",
    "Yemen" = "Yemen, Rep.")

# Filter only countries in happiness dataset
happ_attr2019 <- 
  full_join(happ_attr2019, pop_ests2018, by = "country") %>%
  filter(!is.na(overall_rank)) 
```

```{r avg-attr-scores}
# Compute average attribute scores for each attribute
attr_scores2019 <- happ_attr2019 %>%
  group_by(attr) %>%
  summarise(mean_attr_score = mean(attr_score))

# Insert average attribute scores in df
happ_attr2019 <- full_join(happ_attr2019, attr_scores2019, by = "attr")
```

```{r happiness-attr2019, fig.width = 6.5, fig.height = 6, fig.align= "center", fig.cap = "Attribute Scores of all Countries"}
happ_attr2019_plot <- ggplot(data = happ_attr2019,
       aes(x = 1:nrow(happ_attr2019), # x: number of rows in dataset
           y = attr_score)) +
  geom_point(aes(
    colour = region,
    alpha = 0.8,
    size = pop_total,
    label = country
  )) +
  scale_colour_brewer(palette = "Paired") +
  # Remove x-axis title, lable and ticks
   theme(axis.title.x=element_blank(),
         axis.text.x=element_blank(),
         axis.ticks.x=element_blank()) +
  facet_wrap(~ attr, 
             scales = "free_y", # rescale each attribute score
             ncol = 3,
             nrow = 2,
             strip.position = "bottom"
             ) +
  geom_line(aes(y = mean_attr_score, # Add average attribute 
                x = 1:nrow(happ_attr2019),
                group = attr),
            colour = "black",
            alpha = 0.7,
            linetype = "dashed") +
  labs(y = "Attribute Scores") +
  theme(legend.position = "none",
        panel.background = element_rect(fill = "light grey")
        )

happ_attr2019_plot

# Interactive map
# ggplotly(happ_attr2019_plot, tooltip = c("colour","label", "y", "size"))
```

The y-axis represents the attribute scores for a given attribute. Each dot symbolises a country's attribute score and the black dashed line represents the average attribute score across all countries for each specific attribute.   

Of paramount importance, these factors do not have an impact on the happiness score reported for each country but is used to understand the sources of variations in happiness among countries.

Figure \@ref(fig:happiness-attr2019) shows large gaps between the top and bottom countries in each criterion. Like in figure \@ref(fig:world-happiness-map), countries in the Scandinavian region has the highest scores while Africa had low attribute scores in most of the six attributes. 

Next, large variations are illustrated within regions in most of the attributes except for 'healthy life expectancy'. For instance, in 'GDP per capita' and 'freedom', only approximately half of Central and Eastern Europe were above average. In contrary, a consistent pattern can be seen in healthy life expectancy across regions.

The next section of this report will investigate these key criteria to see if happiness scores can be accurately attributed or explained these variables of the different countries (**Double check this statement with Karen/Wei Hao**).

\clearpage
