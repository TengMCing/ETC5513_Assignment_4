---
title: "Exploratory analysing on World Happiness Report"
author:
- familyname: Li
  othernames: Weihao
  address: Monash University
  email: wlii0039@student.monash.edu
  correspondingauthor: true
  qualifications: 28723740
- familyname: Curie
  othernames: Pierre
  address: University of Paris
  qualifications: Nobel Prize, PhD
department: Department of\newline Econometrics &\newline Business Statistics
organization: ETC5513 Assignment 4
bibliography: references.bib
biblio-style: apa
linestretch: 1.5
output:
  MonashEBSTemplates::report:
    fig_caption: yes
    fig_height: 5
    fig_width: 8
    includes:
      in_header: preamble.tex
    keep_tex: yes
    number_sections: yes
    citation_package: biblatex
    toc: false
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, cache=TRUE, messages=FALSE, warning=FALSE)
```

```{r library}
library(ggplot2)
library(janitor)
library(here)
library(lubridate)
library(rnaturalearth)
library(sf)
library(tidyverse)
```

```{r read-in, cache = TRUE}
happiness_2015 <- read.csv(here::here("Data/2015.csv")) # To extract region info
happiness_2018 <- read.csv(here::here("Data/2018.csv"))
happiness_2019 <- read.csv(here::here("Data/2019.csv"))
```

# Data Wrangling

```{r data-wrangle}
happiness_2018 <- happiness_2018 %>% 
  # Add year
  mutate(year = year(ymd("2018-12-31")),
         Perceptions.of.corruption = as.numeric(Perceptions.of.corruption)) %>%
  rename(Country = Country.or.region)
  
happiness_2019 <- happiness_2019 %>%
  mutate(year = year(ymd("2019-12-31"))) %>% 
  rename(Country = Country.or.region)

happiness_all <- bind_rows(happiness_2018,
                           happiness_2019)

# Find conflicting names and countries in 2019 not in 2018
# setdiff(happiness_2019$Country, happiness_2018$Country) 

happiness_all$Country <-
  recode(happiness_all$Country, "North Macedonia" = "Macedonia")

happiness_all <- happiness_all %>%
  filter(!(Country %in% c("Gambia", "Swaziland", "Comoros")))
```

```{r ctry-region}
# Extract Countries and Regions from 2015 df
ctry_region <- happiness_2015 %>% 
  select(Country, Region)

# Find countries that do not have a region
setdiff(happiness_all$Country, ctry_region$Country) 

ctry_region$Country <-
  recode(
    ctry_region$Country,
    "North Cyprus" = "Northern Cyprus",
    "Trinidad and Tobago" = "Trinidad & Tobago",
    "Somaliland region" = "Somalia")
```

```{r add-ctry-region}
# Insert regions to NA regions
ctry_region <- ctry_region %>% 
  add_row(Country = "Belize", Region = "Latin America and Caribbean") %>%
  add_row(Country = "Namibia", Region = "Sub-Saharan Africa") %>%
  add_row(Country = "South Sudan", Region = "Sub-Saharan Africa") %>%
  mutate(Region = as.factor(Region)) 
```

```{r join-happiness-region}
# Include regions in df
# Clean names
happiness_all <- full_join(happiness_all, ctry_region, by = "Country") %>%
  clean_names()
```

# Analysis 1: World Map

```{r world-map-data}
map_world <- map_data("world")
```

```{r conflict-names, include = FALSE}
# Find conflicting names
setdiff(happiness_all$country, map_world$region)
```

```{r test, eval = FALSE}
# Create new df for map
happiness_map <- happiness_all

# Solve conflicting names
happiness_map$country <-
  recode(
    happiness_map$country,
    "United Kingdom" = "UK",
    "United States" = "USA",
    "Trinidad & Tobago" = "Trinidad",
    "Northern Cyprus" = "Cyprus",
    "Hong Kong" = "China",
    "Palestinian Territories" = "Palestine",
    "Congo (Brazzaville)" = "Republic of Congo",
    "Congo (Kinshasa)" = "Democratic Republic of the Congo",
  )
```

```{r}
# Join map and happiness data
map_combined <- 
  left_join(map_world, happiness_map, by = c('region' = 'country')) 
```

```{r}
ggplot(data = map_combined) +
  geom_polygon(aes(x = long, y = lat, group = group, fill = score)) +
  coord_equal() +
  ggtitle("Happiness Attribute Scores around the World")

library(plotly)
ggplotly()
```


# Analysis 2: Population Data
```{r}
require(rnaturalearth)
world <- ne_countries(scale = "medium", returnclass = "sf") 

setdiff(happiness_all$country, world$name)
```

```{r}
pop_ests <- readxl::read_xlsx("WPP2019_POP_F01_1_TOTAL_POPULATION_BOTH_SEXES.xlsx")
```








