---
title: "Exploratory analysing on World Happiness Report"
author:
- familyname: Li
  othernames: Weihao
  address: Monash University
  email: wlii0039@student.monash.edu
  correspondingauthor: true
  qualifications: 28723740
- familyname: Luo
  othernames: Jinhao
  address: Monash University
  email: jluo0015@student.monash.edu
  correspondingauthor: true
  qualifications: 29012449
- familyname: He
  othernames: Xitong
  address: Monash University
  email: xhee0013@student.monash.edu
  correspondingauthor: true
  qualifications: 29026342
department: Department of\newline Econometrics &\newline Business Statistics
organization: ETC5513 Assignment 4
bibliography: references.bib
biblio-style: apa
linestretch: 1.5
output:
  MonashEBSTemplates::report:
    fig_caption: yes
    fig_height: 5
    fig_width: 8
    includes:
      in_header: preamble.tex
    keep_tex: yes
    number_sections: yes
    citation_package: biblatex
    toc: false
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, cache=FALSE, message=FALSE, warning=FALSE)
# Make sure you have the latest versions of rmarkdown and bookdown installed
library(ggplot2)
library(tidyverse)
library(dplyr)
library(relaimpo)
library(GGally)
library(kableExtra)
library(rnaturalearth)
library(sf)
library(rgeos)
library(lwgeom)
library(car)
library(here)
library(lubridate)
library(cowplot)
library(janitor)
library(maps)
library(plotly)
require(wbstats)
here <- here::here
select = dplyr::select
```

\clearpage

# Introduction

@helliwell2019world has indicated that there is an inner connection between government and happiness, it means the jobs of government would influence the happiness of citizens, while the people feeling of happiness could guide them to decide which kind of government to support. In addition, @helliwell2019world has also explained that the living quality of people could be measured by the happiness of each country. Therefore, this report has utilized the happiness score of each country to analyse the changing of well-being according to countries, regions, and the world. The happiness scores will be allocated into a world map to explain the stark differences in happiness scores across the world. Subsequently, six key variables relating to socioeconomical factors are critically analysed to explain the sources of variations in happiness among countries.  

The report has also analysed the importance of each modelling variables, as well as the relationships between happiness scores and other factors. During the study, this report has found the trends and distribution of happiness scores. Meanwhile, this report has explored the relative importance variables for modelling happiness scores and the correlation between happiness scores and five factors. ------what do you find(weihao's part)------. However, the number of countries observed was not consistent across the datasets, which might generate errors when calculating the average level and analyse the trends over the years. Also, these factors are standardised and have been transformed in unknown way,which will be difficult to construct the model for analysing the relationship between happiness scores and other five factors.

# Data interpretation

We downloaded the data from Kaggle with the license of CCO:Public Domain, which contain the different factors and happiness scores between 2015-2019. In the five datasets, the variable for evaluating the happiness scores about GDP, health, freedom, generosity and government corruption are consistent but the family factor has been changed into social support after 2017. Also, the datasets are ranked from the highest one to the lowest one and the average of the observations are around 156 countries. The happiness scores are based on answered the main life evaluation in the Gallup World Poll. In this report, we are going to use these five datasets to analyse a series of questions for the happiness scores.


\clearpage

# Q1.The evolution of world happiness

```{r read-data}
happiness_2015 <- read_csv(here("data", "2015.csv"))
happiness_2016 <- read_csv(here("data", "2016.csv"))
happiness_2017 <- read_csv(here("data", "2017.csv"))
happiness_2018 <- read_csv(here("data", "2018.csv"))
happiness_2019 <- read_csv(here("data", "2019.csv"))
```

```{r wrangling-2016-data}

data_2016 <- happiness_2016 %>% 
  select(Country, `Happiness Score`) %>% 
  rename("2016-01-01" = "Happiness Score") 
# The reason why rename by "year-01-01" is trying to transfer the type as date and extracted the year for plotting the line chart
```

```{r wrangling-2017-data}
data_2017 <- happiness_2017 %>% 
  select(Country, Happiness.Score) %>% 
  rename("2017-01-01" = "Happiness.Score")
```

```{r wrangling-2018-data}
data_2018 <- happiness_2018 %>% 
  select(`Country or region`, Score) %>% 
  rename("2018-01-01" = "Score",
         "Country" = "Country or region")
```

```{r wrangling-2019-data}
data_2019 <- happiness_2019 %>% 
  select(`Country or region`, Score) %>% 
  rename("2019-01-01" = "Score",
         "Country" = "Country or region")
```

```{r Whole-world-comparison-2015, fig.cap="The percentage of the number of countries above or below average happiness scores in 2015"}
total_countries_2015 <- happiness_2015 %>% 
  select(Country) %>% count()

comparison_2015 <- happiness_2015 %>% 
  mutate(total_countries = total_countries_2015$n, average_score = mean(`Happiness Score`)) %>% 
  #mutate the total number to calculate the number of countries that below and above the average
  filter(`Happiness Score` > average_score) %>% 
  mutate(above_average = length(Country), below_average = total_countries - above_average)

# Try to make a pie chart of 2015 and show the pecentage in the plot
pie_2015 <- comparison_2015 %>% 
  select(above_average, below_average) %>% 
  unique() %>% 
  gather("average", "count", above_average, below_average) %>% 
  mutate(percentage = round(count/sum(count) * 100, digits = 2)) %>% 
  mutate(percentage_label = paste(percentage, "%")) %>%    # To make the label as percentage format
  ggplot(aes("", percentage, fill = average)) + 
  geom_col(stat= "identity", width = 1) + 
  coord_polar("y", start = 0, direction = -1) +
  theme_void() + 
  geom_text(position = position_stack(vjust = 0.5), aes(label = percentage_label)) + 
  ggtitle("The comparison of average score in 2015")

```

```{r Whole-world-comparison-2019, fig.cap="The percentage of the number of countries above or below average happiness scores in 2019"}

total_countries_2019 <- happiness_2019 %>% 
  select(`Country or region`) %>% count()

comparison_2019 <- happiness_2019 %>% 
  mutate(total_countries = total_countries_2019$n, average_score = mean(Score)) %>% 
  filter(Score > average_score) %>% 
  mutate(above_average = length(`Country or region`), below_average = total_countries - above_average)

# Try to make a pie chart of 2019 and show the pecentage in the plot
pie_2019 <- comparison_2019 %>% 
  select(above_average, below_average) %>% 
  unique() %>% 
  gather("average", "count", above_average, below_average) %>% 
  mutate(per = round(count/sum(count) * 100, digits = 2)) %>% 
  mutate(per_label = paste(per, "%")) %>%
  ggplot(aes("", per, fill = average)) + 
  geom_col(stat = "identify", width = 1) + 
  coord_polar("y", start = 0, direction = -1) +    #-1 make the smaller part at the right hand side
  theme_void() + 
  geom_text(aes(label = per_label), position = position_stack(vjust = 0.5)) + 
  ggtitle("The comparison of average score in 2019")
```


@helliwell2019world has indicated that the world has become a rapidly changing place, and such the fastest changing might influence many aspects of different countries on their people. Therefore, in order to explore how satisfied people are with their countries over years, this report has used the happiness score to consider it.

## The trends in happiness 2015-2019

In this part, the top ten countries in 2015 have been extracted to consider how their happiness changing during the five years. According to table \@ref(tab:top10-countries-2015), it has shown that Switzerland

```{r top10-countries-2015}
# Show the top10 countries in 2015 and plot a table
top10_2015  <- happiness_2015 %>%
  filter(`Happiness Rank` <= 10) %>%
  select(Country, `Happiness Score`) %>%
  rename("2015-01-01" = "Happiness Score")

top10_2015 %>% 
  arrange(desc(`2015-01-01`)) %>% 
  rename("2015" = "2015-01-01") %>% 
  kable(caption = "Top10 countries in 2015") %>%
  kable_styling(bootstrap_options = c("bordered", "striped"))
```

has occupied first place in 2015, which was around 7.59 points. While Iceland was around 0.02 standing in second place. In addition, Australia was the tenth country, which was around 7.28. Based on figure \@ref(fig:score-trends), which has shown that Finland was the country with a significant increase over

```{r join-data-frame}
# Put all the happiness score data together 
total_data <- list(top10_2015, data_2016, data_2017, data_2018, data_2019) %>%
  reduce(left_join, by = "Country")
```

```{r score-trends, fig.cap = "The trends in happiness scores from 2015-2019 (based on the top10 countries in 2015)"}
# Extract the year, and plot the changing of happiness score based on each year in line chart
total_data_plot <- total_data %>%
  gather("year","score", c(`2015-01-01`,`2016-01-01`,`2017-01-01`,`2018-01-01`,`2019-01-01`)) %>% 
  mutate(year = year(year))

total_data_plot %>% 
  ggplot(aes(year, score, colour = Country)) + 
  geom_line() + 
  geom_point(aes(shape = Country))
```

five years. Finland has increased from just over 7.4 to around 7.77 and has become the happiest country in 2019. Meanwhile, Denmark, Norway, Netherlands, and New Zealand have also experienced an increase in both scores and places compared with 2015. Although the happiness score of Sweden has decreased in the same period, however, the rank of Sweden has improved in 2019. The rest of the four countries have experienced a decrease in both ranks and scores over five years. The reasons for the changing in score and ranks might because of the social welfare, country economic environment, and government policies. Such aspects have all related to each nation a within country so that impacts the satisfaction level.
 
## The dynamics of the world and regional happiness 2015-2019

Besides, this report has also considered the changing of regional happiness. Firstly, this report has explored the percentage of the number of countries which happiness scores above or below the world average level in 2015 and 2019 to consider the overall condition. According to figure \@ref(fig:combination-plots-2015-2019), the percentage of the above-average level has accounted for

```{r combination-plots-2015-2019, fig.cap="The percentage of the number of countries above or below average happiness scores in 2015 and 2019"}
# Combine the above two pie charts
plot_grid(pie_2015,pie_2019, ncol=2)
```

46.84% in 2015, which was 74 countries. While there were still 84 countries that did not reach the average level. In 2019, the percentage of the above-average level has increased to 49.36%, which was 77 countries. And the percentage of the below-average level has decreased to 50.64%. In general, more and more people have satisfied their countries. 
To study the deeper level, figure \@ref(fig:regions-comparison-2015) has explained the number of

```{r regions-comparison-2015, fig.cap="The number of above average happiness scores across regions in 2015", fig.height=4, fig.width=11}
# Show the number of countries that above the average score in 2015, group by each regions
comparison_2015 %>% 
  group_by(Region) %>% 
  count() %>% 
  ggplot(aes(reorder(Region, n), n)) + 
  geom_col(aes(fill = Region)) + 
  coord_flip() + 
  xlab("region") + 
  ylab("count") + 
  scale_y_continuous(breaks = seq(0, 20, by = 1))
  
```

countries that above-average level of each region in 2015. According to that figure, Western Europe, and the region of Latin America and the Caribbean have the highest number, which was 19 countries respectively. While the region of Sub-Saharan Africa has only one country that above the average level in 2015. Furthermore, based on figure \@ref(fig:regions-comparison-2019), western Europe has still stood

```{r regions-comparison-2019, fig.cap="The number of above average happiness scores across regions in 2019", fig.height=4, fig.width=11}
# Show the number of countries that above the average score in 2019, group by each regions
region <- happiness_2015 %>% select(Country, Region)

comparison_2019 %>% 
  left_join(region, by=c("Country or region" = "Country")) %>%
  filter(!is.na(Region)) %>% 
  group_by(Region) %>%
  count() %>% 
  ggplot(aes(reorder(Region, n), n, fill = Region)) + 
  geom_col() +
  coord_flip() +
  xlab("region") +
  ylab("count") + 
  scale_y_continuous(breaks = seq(0,20, by = 1))
```

at the dominant place, which was 19 countries. While Latin America and the Caribbean have lost a country, which totals 18 countries above average level in 2019. Central and Northern Europe have the same number as Latin America and the Caribbean in 2019. Meanwhile, Southern Asia has appeared in the figure in 2019, which was one country above the average level. In addition, North America, the region of Australia and New Zealand, and Sub-Saharan Africa have remained the same level compared with 2015. 
In general, according to the figure of 2015 and 2019, the countries that happiness scores above average level have concentrated on the region of Europe, and Latin America and Caribbean. While the other regions have less number of countries compared with them.

\clearpage

# Happiness and Attribute Scores across the Globe

```{r read-in, cache = TRUE, include = FALSE}
happ_2015 <- read.csv(here::here("Data/2015.csv")) # To extract region info
happ_2019 <- read.csv(here::here("Data/2019.csv"))
```

There is no formal definition of happiness, it is associated with an individual's state of mind, and we usually know it when we feel it. The happiness ranking and scores use data from the Gallup World Poll; Essentially, survey participants are asked, "from a score of 0-10, how happy are you"? [@sachs2018world]

In this section, six key criteria, which encompassess socioeconomic factors of countries are aggregated and quantified to explain the variation of happiness across countries. These criteria include GDP per capita, social support, healthy life expectancy, freedom, generosity, and absence of corruption. This section critically analyses these six variables to determine if happiness does change, according to the quality of the society people live across the world.

\clearpage

## Data, Design and Methodology

```{r happ-2019-wrangle}
happ_2019 <- happ_2019 %>%
  mutate(year = year(ymd("2019-12-31"))) %>% 
  rename(Country = Country.or.region)
```

```{r ctry-region-chk}
# Extract Countries and Regions from 2015 df
ctry_region <- happ_2015 %>% 
  select(Country, Region)

# Find countries that do not have a region
# setdiff(happ_2019$Country, ctry_region$Country) 
ctry_region$Country <-
  dplyr::recode(
    ctry_region$Country,
    "Trinidad and Tobago" = "Trinidad & Tobago",
    "North Cyprus" = "Northern Cyprus",
    "Macedonia" = "North Macedonia",
    "Somaliland region" = "Somalia",
    "Sudan" = "South Sudan")
```



```{r add-ctry-region}
# Insert regions to NA regions
ctry_region <- ctry_region %>% 
  add_row(Country = "Namibia", Region = "Sub-Saharan Africa") %>%
  add_row(Country = "Gambia", Region = "Sub-Saharan Africa") %>%
  add_row(Country = "South Sudan", Region = "Sub-Saharan Africa") %>%
  mutate(Region = as.factor(Region)) 
```

```{r join-happiness-region}
# Include regions in df
# Clean names
happ_2019 <- full_join(happ_2019, ctry_region, by = "Country") %>%
  clean_names()
```

First, the happiness data from 2015 was utilised to retrieve the regions for each  country, these regions are added to the 2018 and 2019 datasets. Countries with omitted regions are then manually inserted. Next, 3 countries with missing attribute scores are removed. 

To construct the happiness score on a map, the world map data is taken from the maps package [@maps] to create a base map and retrieve the geographic coordinates of all countries in the world. Subsequently, the happiness data is further wrangled to resolve conflicting country names between the happiness and the map data; Both datasets are then joined to build the world map with the happiness score of each country.

The attribute scores of the six criteria are evaluated across the various countries and regions. The estimates of population data are employed [@wbstats] to determine if population size affects happiness scores. Similar to the world map, conflicting country names are modified so countries in both datasets match. Consequently, the attribute scores of all countries in the happiness data set are laid out on a scatter plot.

\clearpage 

## Limitations

On top of the survey response bias, it should be noted that some limitations of this analysis include non-sampling errors such as defects in the selection of survey participants and population coverage limitations. Further, with a holistic approach in determining happiness scores of each country, minute details such as  in each city or state within countries cannot be computed. Lastly, the happiness data is aggregated, thus evaluations such as comparisons between different genders or age groups may not be established.

\clearpage

## Analysis 1: 2019 Happiness Scores on the World Map

```{r world-map-data}
require(maps)
map_world <- map_data("world")
```

```{r conflict-names, include = FALSE}
# Find conflicting country names
setdiff(happ_2019$country, map_world$region)
```

```{r cleaning-ctry-names}
# Create new df for map
happ_map <- happ_2019

# setdiff(happ_2019$country, map_world$region)

# Solve conflicting names
happ_map$country <-
  dplyr::recode(
    happ_map$country,
    "United Kingdom" = "UK",
    "United States" = "USA",
    "Trinidad & Tobago" = "Trinidad",
    "Northern Cyprus" = "Cyprus",
    "Hong Kong" = "China",
    "North Macedonia" = "Macedonia",
    "Palestinian Territories" = "Palestine",
    "Congo (Brazzaville)" = "Republic of Congo",
    "Congo (Kinshasa)" = "Democratic Republic of the Congo")
```

```{r happiness-map-combine}
# Join map and happiness data
map_combined <- 
  left_join(map_world, happ_map, by = c('region' = 'country')) %>%
  rename(country = "region")
```

```{r world-happiness-map, fig.align = "center", out.height="45%", fig.cap = "Happiness Scores of Countries around the World"}
happ_map_plot <- ggplot(data = map_combined) +
  geom_polygon(aes(
    x = long,
    y = lat,
    group = group,
    fill = score,
    label = country 
  ), colour = "black") +
  coord_equal() +
  scale_fill_distiller(palette = "PRGn", 
                       na.value = "light grey",
                       limits = c(2, 8)) +
  theme(
  axis.text = element_blank(),
  axis.line = element_blank(),
  axis.ticks = element_blank(),
  axis.title = element_blank(),
  panel.border = element_rect(colour = "black", fill=NA, size = 1.5),
  panel.grid = element_blank(),
  panel.background = element_rect(fill = "light blue"),
  plot.title = element_text(hjust = 0.5, size = 16, face = "bold.italic" )) +
  ggtitle("Happiness Scores around the World") +
  theme(legend.position= "bottom")

happ_map_plot

# Interactive Map
# ggplotly(happ_map_plot, tooltip = c("label", "fill"))

```

Figure \@ref(fig:world-happiness-map) depicts the happiness scores of each country on a world map. The x-axis and y-axis represent the longitude and latitude respectively. It is observed that happiness scores within continents or regions are analogous. For instance, happiness scores in Africa are relatively low compared to the rest of the world. It can be implied that these African countries may have poor happiness scores because of low economical levels or even associated with high political instability and reoccurring periodic outbreaks of armed conflict [@sachs2018world].

Comparatively, continents such as Europe, North America, and Australia have consistently high happiness scores in most countries. Moreover, the top 10 happiest countries are evidently dominated by Scandinavian countries such as Finland and Denmark, which was likewise underlined in the previous section (Figure \@ref(fig:score-trends)).

\clearpage

## Analysis 2: Compare attribute scores across countries

```{r happ-2019-longer}
# Place all attribute scores on one variable for plotting
happ_attr2019 <- happ_2019 %>%
  filter(year == 2019) %>%
  pivot_longer(cols = gdp_per_capita:perceptions_of_corruption, 
               names_to = "attr",
               values_to = "attr_score") 
```

```{r extract-pop-data}
require(wbstats)
# Retrieve population estimates of countries in the world
pop_ests2018 <- wb(indicator = "SP.POP.TOTL", startdate = 2018, enddate = 2019)

pop_ests2018 <- pop_ests2018 %>%
  select(country, value) %>%
  rename(pop_total = value)
```

```{r wrangling-for-pop-data}
# Make country names consistent with population data 
# setdiff(happiness_attr2019$country,pop_ests2018$country)
happ_attr2019$country <-
  dplyr::recode(
    happ_attr2019$country,
    "Taiwan" = "China",
    "Slovakia" = "Slovak Republic",
    "Trinidad & Tobago" = "Trinidad and Tobago",
    "South Korea" = "Korea, Rep.",
    "Northern Cyprus" = "Cyprus",
    "Russia" = "Russian Federation",
    "Hong Kong" = "Hong Kong SAR, China",
    "Kyrgyzstan" = "Kyrgyz Republic",
    "Macedonia" = "North Macedonia", 
    "Ivory Coast" = "Cote d'Ivoire",
    "Congo (Brazzaville)" = "Congo, Rep.",
    "Laos" = "Lao PDR",
    "Venezuela" = "Venezuela, RB",
    "Palestinian Territories" = "West Bank and Gaza",
    "Iran" = "Iran, Islamic Rep.",
    "Congo (Kinshasa)" = "Congo, Dem. Rep.",
    "Swaziland" = "Swaziland",
    "Gambia" = "Gambia",
    "Egypt" = "Egypt, Arab Rep.",
    "Syria" = "Syrian Arab Republic",
    "Yemen" = "Yemen, Rep.")

# Filter only countries in happiness dataset
happ_attr2019 <- 
  full_join(happ_attr2019, pop_ests2018, by = "country") %>%
  filter(!is.na(overall_rank)) 
```

```{r avg-attr-scores}
# Compute average attribute scores for each attribute
attr_scores2019 <- happ_attr2019 %>%
  group_by(attr) %>%
  summarise(mean_attr_score = mean(attr_score))

# Insert average attribute scores in df
happ_attr2019 <- full_join(happ_attr2019, attr_scores2019, by = "attr")
```

```{r happiness-attr2019, fig.width = 6.5, fig.height = 6, fig.align= "center", fig.cap = "Attribute Scores of all Countries"}
happ_attr2019_plot <- ggplot(data = happ_attr2019,
       aes(x = 1:nrow(happ_attr2019), # x: number of rows in dataset
           y = attr_score)) +
  geom_point(aes(
    colour = region,
    alpha = 0.8,
    size = pop_total,
    label = country
  )) +
  scale_colour_brewer(palette = "Paired") +
  # Remove x-axis title, lable and ticks
   theme(axis.title.x=element_blank(),
         axis.text.x=element_blank(),
         axis.ticks.x=element_blank()) +
  facet_wrap(~ attr, 
             scales = "free_y", # rescale each attribute score
             ncol = 3,
             nrow = 2,
             strip.position = "bottom"
             ) +
  geom_line(aes(y = mean_attr_score, # Add average attribute 
                x = 1:nrow(happ_attr2019),
                group = attr),
            colour = "black",
            alpha = 0.7,
            linetype = "dashed") +
  labs(y = "Attribute Scores") +
  theme(legend.position = "none",
        panel.background = element_rect(fill = "light grey")
        )

happ_attr2019_plot

# Interactive map
# ggplotly(happ_attr2019_plot, tooltip = c("colour","label", "y", "size"))
```

The y-axis represents the attribute scores for a given attribute. Each dot symbolises a country's attribute score and the black dashed line represents the average attribute score across all countries for each specific attribute. Of paramount importance, these factors do not have an impact on the happiness score reported for each country but is used to understand the sources of variations in happiness among countries.

Figure \@ref(fig:happiness-attr2019) shows large gaps between the top and bottom countries in each criterion. Like in figure \@ref(fig:world-happiness-map), countries in the Scandinavian region has the highest scores while Africa had low attribute scores in most of the six attributes. 

Next, large variations are illustrated within regions in most of the attributes except for 'healthy life expectancy'. For instance, in 'GDP per capita' and 'freedom', only approximately half of Central and Eastern Europe were above average. In contrary, a consistent pattern can be seen in healthy life expectancy across regions.

The next section of this report will investigate these key criteria to see if happiness scores can be attributed to or explained by these variables of the different countries.

\clearpage

# Question 3 : Which variables are useful for modelling happiness scores and how the correlation between happiness scores and other factors?

```{r loaddata}
data2015 <- read.csv(here::here("Data/2015.csv"))
data2016 <- read.csv(here::here("Data/2016.csv"))
data2017 <- read.csv(here::here("Data/2017.csv"))
data2018 <- read.csv(here::here("Data/2018.csv"))
data2019 <- read.csv(here::here("Data/2019.csv"))
GDP<-read_csv("Data/API_NY.GDP.MKTP.CD_DS2_en_csv_v2_1120928.csv",skip=4)
CPI<-read_csv("Data/API_FP.CPI.TOTL.ZG_DS2_en_csv_v2_1120899.csv", skip = 4)
Population<- read_csv("Data/API_SP.POP.TOTL_DS2_en_csv_v2_1120881.csv", skip = 4)
world_map <-ne_countries(returnclass = "sf")
```

  To explore the factors that could be contributing to the happiness score differences between each year,a **linear regression model** is established by testing the relationship between predictor and response variables.From the **LM** result, we can conclude the estimated closed form of happiness score:

\begin{align*}
\text{Happiness score} = & \text{ GDP per Capital } + \text{ Family } + \text{ Life expectancy }+ \text{ Freedom } +   \\ 
&  \text{ Government Corruption } + \text{ Generosity } + \text{Dystopia Residual }
\end{align*}
  The **Table \@ref(tab:model2015)** is shown that there is strong evidence that the happiness score is and only is a simple average of these factors. In addition, all the R squared are close to 1 from 2015 to 2017 in the **Table \@ref(tab:Rsquared)** ,indicating that these factors are standardized and no longer to use as building up a model. Besides, for 2018 and 2019 data, the organization provides another set of variables such as social support has been changed from family factor, which are also highly correlated with the happiness score, but we have no method to understand what those values represent since they have been transformed in an unknown manner.
  
  Instead of using the factors in the given dataset, we join other datasets to analysis the happiness score, including GDP, CPI, population and area by different countries. There are another three datasets such as GDP, CPI and population data which are downloaded from The World Bank. And area of each country is computed using the simple feature polygons with the package `rnaturalearth` [@rnaturalearth]. In addition, we pick up thee variables such as GDP,CPI and population between 2015-2019 to put them into new happiness score dataset. After matching the area of each country and drop out the missing value, the new dataset with happiness score for analyzing the relative variable importance is established in the **Table \@ref(tab:tableHS)**.
  
  
```{r lmmodel}
model2015 <- lm(as.formula(paste('`', 
                            colnames(data2015)[4], "`~`",
                            paste(colnames(data2015)[c(6, 7, 8, 9, 10, 11, 12)], collapse = "`+`"),
                            '`',
        sep = ""
    )), data = data2015)
model2016 <- lm(as.formula(paste('`', 
                            colnames(data2016)[4], "`~`",
                            paste(colnames(data2016)[c( 7, 8, 9, 10, 11, 12,13)], collapse = "`+`"),
                            '`',
        sep = ""
    )), data = data2016)
model2017 <- lm(as.formula(paste('`', 
                            colnames(data2017)[3], "`~`",
                            paste(colnames(data2017)[c(5,6, 7, 8, 9, 10, 11)], collapse = "`+`"),
                            '`',
        sep = ""
    )), data = data2017)
```

```{r model2015,fig.cap="Estimated coefficient in the LM model in 2015 dataset"}
c_table <- summary(model2015)
rownames(c_table$coefficients) = c_table$coefficients %>%
  rownames() %>%
  stringr::str_remove_all('`')
c_table$coefficients %>%
  knitr::kable(
               caption = "Linear regression model for happiness scores in 2015") %>%
  kableExtra::kable_styling(latex_options = "striped")
```


```{r Rsquared,fig.cap="R squared value from 2015 to 2017"}
R15<-summary(model2015)$r.squared 
R16<-summary(model2016)$r.squared 
R17<-summary(model2017)$r.squared 
x<-data.frame(R15,R16,R17)
names(x)[1] <- "2015"
names(x)[2] <- "2016"
names(x)[3] <- "2017"
x%>%kable(caption = ' R Squared in 2015-2017') %>%
  kable_styling(bootstrap_options = c("striped", "hover"), full_width = FALSE)
```

```{r clean-data}
temp <-data2015 %>%
  dplyr::select(1,`Happiness Score` = Happiness.Score) %>%
  mutate(year = 2015)
data2016 %>%
  dplyr::select(1,`Happiness Score` = Happiness.Score) %>%
  mutate(year = 2016) %>%
  rbind(temp) -> temp
data2017%>%
  dplyr::select(1, `Happiness Score` = Happiness.Score) %>%
  mutate(year = 2017) %>%
  rbind(temp) -> temp
data2018 %>%
  dplyr::select(Country = `Country.or.region`, `Happiness Score` = Score) %>%
  mutate(year = 2018) %>%
  rbind(temp) -> temp
data2019 %>%
  dplyr::select(Country = `Country.or.region`, `Happiness Score` = Score) %>%
  mutate(year = 2019) %>%
  rbind(temp) -> temp
```

```{r}
happy_score<- temp
```


```{r clean-other-three-dataset}

Population %>%
  dplyr::select(Country = `Country Name`, `2015`:`2019`) %>%
  gather(key = 'year', value = 'population', `2015`:`2019`) %>%
  mutate(year = as.numeric(year)) %>%
  right_join(happy_score) -> happy_score
GDP %>%
  dplyr::select(Country = `Country Name`, `2015`:`2019`) %>%
  gather(key = 'year', value = 'gdp', `2015`:`2019`) %>%
  mutate(year = as.numeric(year)) %>%
  right_join(happy_score) -> happy_score
CPI %>%
  dplyr::select(Country = `Country Name`, `2015`:`2019`) %>%
  gather(key = 'year', value = 'cpi', `2015`:`2019`) %>%
  mutate(year = as.numeric(year)) %>%
  right_join(happy_score) -> happy_score
```

```{r using-rnaturalearth}
world_map$area = st_area(world_map) %>% as.numeric()
as_tibble(world_map) %>%
  dplyr::select(area, name) %>%
  right_join(happy_score, by = c('name' = 'Country')) -> happy_score

```

```{r tableHS,fig.cap="construct a new dataset for analysing happiness score"}
happy_score<-happy_score%>% drop_na()
head(happy_score)%>%kable(caption = 'A clean dataset with Happiness Score')%>%
  kable_styling(bootstrap_options = c("striped", "hover"), full_width = FALSE)
```

\clearpage


## Variable importance

  For comparing the relative importance with each predictors, the **lmg** approach with package `relaipmo` [@relaimpo] is used for evaluating the variable importance in modelling happiness score. By using **lmg** approach to  calculate the relative contribution of each predictor to the R squared with the consideration of the sequence of predictors appearing in the model. 
  
  Firstly, we built up a **LM** model for the new happiness score dataset. By eliminating the heteroskedasticity in the residual and interpreting the percentage marginal effect of each variable, using logarithmic method for setting up a linear regression model is an appropriate way. Therefore, a **LM** model is shown :
\begin{align*}
\text{log(Happiness Score)} = & \text{ CPI} +  \text{ log(GDP)}+\text{ log(Area)}+ \text{ log(Population)} 
\end{align*}

  From **Figure \@ref(fig:variable-important)**,we can see that the total proportion of variance explained by the model with all four predictors is around 72.88%. For the four predictors, GDP with the highest value in four predictors contributed to around 65% for the happiness scores,indicating that GDP factor is the most important for happiness score and it is more likely to affect the change of happiness scores when the GDP variable change [@gromping2015variable]. On the other hand,by using **variance inflation factor** (VIF) measure to evaluate the impact of the correlation among the explanatory variables. In the **Table \@ref(tab:mulitilinearity)**, the VIF value in each predictor is not too high but for the population variable is the highest one around at 3, indicating that there is a slight correlation of population with other variables in the model [@daoud2017multicollinearity].

## Scatter matrix
  To analyze the relationship between different predictors, we use scatter matrix which can be visualized easily how much one variable is affected by another or the relationship between them. The **Figure \@ref(fig:scattermatrix)** compares all the predictors in the model and represents the relationship between these variables. If there is a strong positive linear correlation between two factors, we can say that if one factor is important in evaluating the happiness scores, it is likely that the other factor has contribute to it as well. Based on the figures, it seems that the importance of GDP and area are strongly correlated, as well as population and area. Therefore,GDP is the most important factors for evaluating the happiness scores as it has the highest positive correlation with happiness score,but also for the developed countries in most of western area with highest GDP, the happiness scores will be higher than the development countries with lower GDP.
  
  In conclusion, GDP is the most influential factors for assessing the happiness scores but the area variable represents a higher correlation with GDP. Thus, Even in very poor countries, GDP comparisons seem to influence the happiness score mostly; however, it may look more likely to happen in rich-country phenomenon [@clark2011will].
  

```{r variable-important,fig.cap="Variable importance in happiness score"}

model <- lm(log(`Happiness Score`)~log(area)+cpi+log(gdp)+log(population), data=happy_score)
  
  relImportance<-model%>%relaimpo::calc.relimp(type="lmg",rela=TRUE)
  #tibble('R^2' =relImportance$R2*100 , 'log(gpd)' = relImportance$lmg[3]*100,'log(population)' = relImportance$lmg[4]*100,'log(cpi)' = relImportance$lmg[2]*100,'log(area)' = relImportance$lmg[1]*100)%>%
  #pivot_longer(cols = c('R^2', 'log(gpd)','log(population)','log(cpi)','log(area)'), names_to = "Relative importance",values_to = "Important(%)") %>%
  #kable(caption = 'Variable importance in happiness score') %>%
  #kable_styling(bootstrap_options = c("striped", "hover"), full_width = FALSE, position = "left")
  
  data.frame(name = c('log(area)', 'cpi', 'log(gdp)', 'log(population)'), lmg = relImportance@lmg) %>%
    ggplot()+
    geom_bar(aes(name,lmg), stat = "identity") +
    ylab('% of R^2') +
    xlab(paste0('R^2 = ', round(relImportance@R2, digits = 4), ', metrics are normalized to sum 100%')) +
    ggtitle("Relative importance for log(Happiness Score)\nMethod LMG")
```

```{r mulitilinearity,fig.cap="VIF procedures in each predictors"}
as.table(car::vif(model))%>%
  kable(caption = 'VIF procedures for checking multicollinearity with each predictors') %>%
  kable_styling(bootstrap_options = c("striped", "hover"), full_width = FALSE, position = "left")
  
```

\clearpage

```{r scattermatrix,fig.cap="Happiness Score Scatter Matrix", fig.width = 10, fig.height = 10}
ggpairs(data=happy_score[,-c(2,3)],
         main="Happiness Score Scatter Matrix")
```

\clearpage

# Q4. What is the relationship between predictors and happiness score in linear regression analysis?

```{r message=FALSE}
h15 = read_csv("Data/2015.csv")
h16 = read_csv("Data/2016.csv")
h17 = read_csv("Data/2017.csv")
h18 = read_csv("Data/2018.csv")
h18$`Perceptions of corruption` = as.numeric(h18$`Perceptions of corruption`)
h19 = read_csv("Data/2019.csv")
```


```{r message=FALSE, warning=FALSE}
library(rnaturalearth)
library(sf)
world_map = ne_countries(returnclass = 'sf')
gdp = read_csv("Data/API_NY.GDP.MKTP.CD_DS2_en_csv_v2_1120928.csv", skip = 4)
cpi = read_csv("Data/API_FP.CPI.TOTL.ZG_DS2_en_csv_v2_1120899.csv", skip = 4)
population = read_csv("Data/API_SP.POP.TOTL_DS2_en_csv_v2_1120881.csv", skip = 4)
```
```{r}
temp = h15 %>%
  dplyr::select(Country, `Happiness Score`) %>%
  mutate(year = 2015)

h16 %>%
  dplyr::select(Country, `Happiness Score`) %>%
  mutate(year = 2016) %>%
  rbind(temp) -> temp

h17 %>%
  dplyr::select(Country, `Happiness Score` = Happiness.Score) %>%
  mutate(year = 2017) %>%
  rbind(temp) -> temp

h18 %>%
  dplyr::select(Country = `Country or region`, `Happiness Score` = Score) %>%
  mutate(year = 2018) %>%
  rbind(temp) -> temp

h19 %>%
  dplyr::select(Country = `Country or region`, `Happiness Score` = Score) %>%
  mutate(year = 2019) %>%
  rbind(temp) -> temp
```

```{r}
hs = temp
```

```{r message=FALSE}
population %>%
  dplyr::select(Country = `Country Name`, `2015`:`2019`) %>%
  gather(key = 'year', value = 'population', `2015`:`2019`) %>%
  mutate(year = as.numeric(year)) %>%
  right_join(hs) -> hs

gdp %>%
  dplyr::select(Country = `Country Name`, `2015`:`2019`) %>%
  gather(key = 'year', value = 'gdp', `2015`:`2019`) %>%
  mutate(year = as.numeric(year)) %>%
  right_join(hs) -> hs

cpi %>%
  dplyr::select(Country = `Country Name`, `2015`:`2019`) %>%
  gather(key = 'year', value = 'cpi', `2015`:`2019`) %>%
  mutate(year = as.numeric(year)) %>%
  right_join(hs) -> hs
```

```{r warning=FALSE, message=FALSE}
world_map$area = st_area(world_map) %>% as.numeric()

as_tibble(world_map) %>%
  dplyr::select(area, name) %>%
  right_join(hs, by = c('name' = 'Country')) -> hs

```


```{r }
nona_hs = na.omit(hs)

nona_hs = nona_hs %>%
  mutate(log_score = log(`Happiness Score`), log_gdp = log(gdp), log_area = log(area), log_population = log(population)) %>%
  dplyr::select(log_score:log_population, name, year, cpi)

lm(log_score~cpi+log_gdp+log_population+log_area,data=nona_hs) %>%
  summary() -> lm_sum

```

```{r lmcoeff}

rownames(lm_sum$coefficients) = lm_sum$coefficients %>%
  rownames() %>%
  stringr::str_remove_all('`')

lm_sum$coefficients %>%
  knitr::kable('latex', 
               digits = 4, 
               booktabs = TRUE,
               caption = "Linear regression model for happiness scores. The $R^2$ of this model is 0.7264.") %>%
  kableExtra::kable_styling(latex_options = "striped")
```

We use variables mentioned in Q3 as predictors, the regression result is shown in **Table** \ref{tab:lmcoeff}. According to the result, we can write down the formula for this model:

\begin{align*}
\text{log(Happiness Score)} = & \ 0.3208 + 0.0005\text{ CPI} + 0.1285 \text{ log(GDP)} \\
&- 0.1218 \text{ log(Population)} + 0.0056 \text{ log(Area)}
\end{align*}

Notice that only the intercept, log of GDP and the log of the population are significant with $\alpha = 5$%. Since we take logarithm on both response variable and regressors except CPI given it is a percentage index, we can interpret them as the elasticity of happiness score of GDP and the elasticity of happiness score of the population. This can be proved by:

\begin{align}
\frac{\partial \text{log(Happiness Score)}}{\partial \text{log(GDP)}} &= 0.1285\\
\intertext{From (1) we can say, when other variables remain constant }\nonumber \\
\Delta \text{ log(Happiness Score)} &= 0.1285 \Delta \text{ log(GDP)}\\
\intertext{By using the linear approximation of log function, we can know}\nonumber\\
log(x_0 + \Delta x) - log(x_0) &\approx log(x_0) + log'(x_0)\Delta x - log(x_0)\\
&=  \frac{\Delta x}{x_0} = \text{percentage change in x}\nonumber\\
\intertext{Therefore}\nonumber\\
\frac{\Delta \text{ log(Happiness Score)}}{\Delta \text{ log(GDP)}} &\approx \frac{\Delta \text{ Happiness Score}}{\Delta \text{ GDP} }\frac{\text{GDP}}{\text{Happiness Score}}\\
&=\frac{\% \Delta \text{ Happiness Score}}{\% \Delta \text{ GDP}} \nonumber\\
&= 0.1285\nonumber
\end{align}

Now we can interpret the result from **Table** \ref{tab:lmcoeff}. Only variables that are statistically significant will be reported. Roughly, a 1% increase in GDP leads to a 0.1285% rise in the happiness score, and a 1% increase in population leads to a 0.1218% fall in the happiness score.

```{r}
world_map$not_included = is.na(sapply(world_map$name, match, table = hs$name))
```



```{r missmap, fig.cap="The world map of missing countries in our dataset"}
ggplot()+
  geom_sf(data = world_map, aes(fill = not_included))+
  ggtitle("World map of countries that are not included in our dataset") +
  theme_bw()+
  theme(legend.position = 'bottom') +
  labs(fill = "Not included")
```




Apparently, the happiness score can be affected by other factors that correlated with regressors and doesn't include in our model, such as the education index and the social welfare system. It means an endogeneity issue occurs in our model, which leads our estimator to be bias and inconsistent. We can either include other variables that we think will be useful for happiness score prediction, or find instrumental variable and fit a Two-Stage least squares regression. Besides, another issue with our model is the sample selection problem. There are only 126 countries with completed cases in our final dataset, which means 69 countries are not considered. **Figure** \ref{fig:missmap} shows the map of missing countries. According to the map, most of the countries being omitted are developing countries. It indicates that our samples are not randomly selected from the population, and we are facing an observability issue. It can be expected that the happiness scores in those countries are lower than the average, which suggests we potentially underestimate our coefficients in OLS. 

The diagnostics of our regression is shown in **Figure** \ref{fig:dig}. From the Residuals vs Fitted plot, we can see the non-constant variance across the fitted value. The model can be adjusted using Heteroskedasticity and Autocorrelation Consistent (HAC) covariance matrix estimation [@newey1986simple] to let our inference to be credible. The QQ plot suggests the density of residuals is asymmetric, but it is very close to a normal distribution. In the Cooks distances vs Fitted plot, we use 4/(n-k-1) as the threshold suggested in the book written by @fox2019regression. The most influential points are from Suriname, Angola, Botswana, Sudan, Gabon, Sierra Leone, Togo and Burundi. **Figure** \ref{fig:ip} shows the pattern of these countries. Most of them are in Africa, which contains extreme values in either happiness scores, GDP, CPI or area. It tells us that Africa is different from other places in the world, and we can consider putting a dummy variable in our model to indicate whether the country is in Africa.

In conclusion, this model does a solid job in explaining the relationship between happiness score and our regressors. 






```{r dig, fig.cap="Regression diagnostics for checking heteroskedasticity, non-normality and influential points", message=FALSE, fig.height=10}
library(ggrepel)
mod = lm(log_score~cpi+log_gdp+log_population+log_area,data=nona_hs)

mod_detail = broom::augment(mod, data = nona_hs)
p1 = ggplot(mod_detail) +
  geom_point(aes(.fitted, .resid)) +
  geom_smooth(aes(.fitted, .resid))

p2 = ggplot(mod_detail) +
  geom_qq(aes(sample = .resid)) +
  geom_qq_line(aes(sample = .resid))

p3 = ggplot(mod_detail) +
  geom_point(aes(.fitted, .cooksd)) +
  geom_text_repel(data = filter(mod_detail, .cooksd>0.0083), aes(.fitted, .cooksd, label = paste0(name,',',year)), col = 'red') +
  geom_point(data = filter(mod_detail, .cooksd>0.0083), aes(.fitted, .cooksd), col="blue")

library(gridExtra)
grid.arrange(arrangeGrob(p1,p2, ncol=2),
         arrangeGrob(p3, ncol=1, nrow=1), top = "Regression diagnostics\n Top left: Residuals vs Fitted. Top right: Normal QQ plot. Bottom:  Cooks distances vs Fitted.", heights=c(1,2))
```


```{r ip, fig.cap="Diagnostics for influential data points", fig.height=10}
p1 = ggplot()+
  geom_sf(data = world_map, aes(fill = name %in% c('Suriname', 'Angola', 'Botswana', 'Sudan', 'Gabon', 'Sierra Leone', 'Togo', 'Burundi'))) +
  theme_bw()+
  theme(legend.position = "bottom") +
  labs(fill = 'With influential points') 

p2 = ggplot(mod_detail) +
  geom_point(aes(log_gdp,.fitted)) +
  geom_point(data = filter(mod_detail, name %in% c('Suriname', 'Angola', 'Botswana', 'Sudan', 'Gabon', 'Sierra Leone', 'Togo', 'Burundi')), aes(log_gdp,.fitted),col="red")

p3 = ggplot(mod_detail) +
  geom_point(aes(cpi,.fitted)) +
  geom_point(data = filter(mod_detail, name %in% c('Suriname', 'Angola', 'Botswana', 'Sudan', 'Gabon', 'Sierra Leone', 'Togo', 'Burundi')), aes(cpi,.fitted),col="red")

p4 = ggplot(mod_detail) +
  geom_point(aes(log_population,.fitted)) +
  geom_point(data = filter(mod_detail, name %in% c('Suriname', 'Angola', 'Botswana', 'Sudan', 'Gabon', 'Sierra Leone', 'Togo', 'Burundi')), aes(log_population,.fitted),col="red")

p5 = ggplot(mod_detail) +
  geom_point(aes(log_area,.fitted)) +
  geom_point(data = filter(mod_detail, name %in% c('Suriname', 'Angola', 'Botswana', 'Sudan', 'Gabon', 'Sierra Leone', 'Togo', 'Burundi')), aes(log_area,.fitted),col="red")

grid.arrange(p1, arrangeGrob(p2, p3, p4,p5, ncol=2), top = "Diagnostics for influential data points\n Top: World map of countries with influential data points. \n Bottom: Scatter plots of fitted value against each regressor. Red dots represent the influential data points.", ncol=1, heights =c(2,1))
```

\clearpage

# Acknowledgement
- package ggplot2 [@ggplot2],
- package tidyverse [@tidyverse],
- package dplyr [@dplyr],
- package relaimpo [@relaimpo],
- package GGally [@GGally],
- package kableExtra [@kableExtra],
- package rnaturalearth [@rnaturalearth],
- package sf [@sf],
- package rgeos [@rgeos],
- package lwgeom [@lwgeom],
- package car [@car],
- package here [@here],
- package lubridate [@lubridate],
- package cowplot [@cowplot]
- package janitor [@janitor]
- package maps [@maps]
- package wbstats [@wbstats]
- package plotly [@plotly]

\clearpage

